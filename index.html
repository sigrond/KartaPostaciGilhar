<html>
<head>
<meta http-equiv="X-UA-Compatible" content="IE=Edge" />
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="jquery.min.js"></script>
<script src="nativeMD5.js"></script>
<script src="protocolTest.js"></script>
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
</head>
<body>

<div class="w3-sidebar w3-bar-block w3-card-2 w3-animate-left w3-mobile" style="display:none" id="mySidebar">
  <button class="w3-bar-item w3-button w3-large w3-green"
  onclick="w3_close()">Close &times;</button>
  <a href="#" class="w3-bar-item w3-button" onclick="pokaz(1)">Strona 1 - Staty, Umiejętności</a>
  <a href="#" class="w3-bar-item w3-button" onclick="pokaz(2)">Strona 2 - Pancerz, Bronie, PD</a>
  <a href="#" class="w3-bar-item w3-button" onclick="pokaz(3)">Strona 3 - Ekwipunek, Monety</a>
  <a href="#" class="w3-bar-item w3-button" onclick="pokaz(4)">Strona 4 - Ekwipunek</a>
  <a href="#" class="w3-bar-item w3-button" onclick="pokaz(5)">Strona 5 - Alchemia</a>
  <a href="#" class="w3-bar-item w3-button" onclick="pokaz(6)">Strona 6 - Magia Pieczęci</a>
  <a href="#" class="w3-bar-item w3-button" onclick="pokaz(7)">Strona 7 - Magia Rytuału, Czary</a>
  <a href="#" class="w3-bar-item w3-button" onclick="pokaz(8)">Strona 8 - Magia Rytuału, Rytuały</a>
  <a href="#" class="w3-bar-item w3-button" onclick="pokaz(9)">Strona 9 - Magia KI</a>
  <a href="#" class="w3-bar-item w3-button" onclick="pokaz(10)">Strona 10 - Magia Krwi</a>
  <a href="#" class="w3-bar-item w3-button" onclick="pokaz(11)">Strona 11 - Sojusznicy</a>
  <a href="#" class="w3-bar-item w3-button" onclick="pokaz(12)">Strona 12 - Mechanizmy</a>
  <a href="#" class="w3-bar-item w3-button" onclick="pokaz(13)">Strona 13 - Postacie</a>
  <a href="#" class="w3-bar-item w3-button" onclick="pokaz('KregiMagii')">Strona 14 - Kręgi Magii</a>
</div>

<div class="w3-main w3-mobile" id="main" style="-webkit-transform-origin: top left;">

<div class="w3-bar w3-teal">
	<button class="w3-button w3-teal w3-xlarge w3-bar-item" onclick="w3_open()">
	<i class="material-icons">menu</i><!--&#9776;--></button>
	<b class="w3-bar-item">Karta Postaci Gilhar </b>
	<i class="w3-bar-item">v.0.3alpha.19</i>
	<div class="w3-dropdown-click w3-dropdown-hover" style="float:right;">
		<button class="w3-button">Kalkulatory</button>
		<div class="w3-dropdown-content w3-bar-block w3-border" style="z-index: 100;">
			<a href="#" class="w3-bar-item w3-button">Staty</a>
			<a href="#" class="w3-bar-item w3-button">Umiejętności</a>
			<a href="#" class="w3-bar-item w3-button">Szkoły Walki</a>
			<a href="#" class="w3-bar-item w3-button">Magie</a>
		</div>
	</div>
	<div class="w3-dropdown-click w3-dropdown-hover" style="float:right;">
		<button class="w3-button">Logowanie</button>
		<div class="w3-dropdown-content w3-bar-block w3-border" style="z-index: 100;">
			<label class="w3-bar-item">Login</label>
			<input id="Login" class="w3-bar-item w3-input w3-border" type="text">
			<label class="w3-bar-item">Hasło</label>
			<input id="Haslo" class="w3-bar-item w3-input w3-border" type="password">
			<input id="Logowanie" class="w3-bar-item w3-button w3-round-xxlarge w3-khaki" type="button" value="Logowanie" onclick="logowanie()">
		</div>
	</div>
	<div class="w3-dropdown-click w3-dropdown-hover" style="float:right;">
		<button class="w3-button">Opcje</button>
		<div class="w3-dropdown-content w3-bar-block w3-border" style="z-index: 100;">
			<a href="#" class="w3-bar-item w3-button">Rejestracja</a>
			<a href="#" class="w3-bar-item w3-button">Zapisz postać do bazy</a>
			<a href="#" class="w3-bar-item w3-button">Wczytaj postać z bazy</a>
			<a href="#" class="w3-bar-item w3-button">Administracja</a>
		</div>
	</div>
</div>

<div id="extra_scripts"></div>

<div id="actual_page"  style="width:100%; height:400%; background-color:lightcyan; float:left; -webkit-transform-origin: top left;"></div>

</div>

<script>
function w3_open() {
	//document.getElementById("main").style.marginLeft = "20%";
	document.getElementById("mySidebar").style.width = "20%";
	document.getElementById("mySidebar").style.display = "block";
	//document.getElementById("openNav").style.display = 'none';
	var desired_size=$("#mySidebar").width();//$(window).width()*0.2;
	console.log("open:"+desired_size);
	$("#main").css({
		"-webkit-transform": "translateX("+desired_size+"px)",
		 "-moz-transform": "translateX("+desired_size+"px)",
		 "-o-transform": "translateX("+desired_size+"px)",
		 "-ms-transform": "translateX("+desired_size+"px)"
	});
	
	var scale=$(window).width()*0.80/909;
	console.log(scale);
	$("#my_object").css({
		 "-webkit-transform": "scale("+scale+")",
		 "-moz-transform": "scale("+scale+")",
		 "-o-transform": "scale("+scale+")",
		 "-ms-transform": "scale("+scale+")"
	});
	$("#my_object").css("width", 1/scale*100+"%");
	$("#my_object").css("height", $(window).height()+"px");
}
function w3_close() {
  //document.getElementById("main").style.marginLeft = "0%";
  var desired_size=$(window).width()*(0);//przesunięcie jest względem panelu, ale samo się nie aktywuje
  console.log("close:"+desired_size);
	$("#main").css({
		"-webkit-transform": "translateX("+desired_size+"px)",
		 "-moz-transform": "translateX("+desired_size+"px)",
		 "-o-transform": "translateX("+desired_size+"px)",
		 "-ms-transform": "translateX("+desired_size+"px)"
	});
  document.getElementById("mySidebar").style.display = "none";
  //document.getElementById("openNav").style.display = "inline-block";
  var scale=$(window).width()/909;
	//console.log(scale);
	$("#my_object").css({
		 "-webkit-transform": "scale("+scale+")",
		 "-moz-transform": "scale("+scale+")",
		 "-o-transform": "scale("+scale+")",
		 "-ms-transform": "scale("+scale+")"
	});
	$("#my_object").css("width", 1/scale*100+"%");
	$("#my_object").css("height", 1/scale*100+"%");
}
function pokaz(i){
	//$("#actual_page").html('<iframe id="my_object" type="text/html" src="'+i+'.html" style="width:100%;height:400%; -webkit-transform-origin: top left;"></iframe>');
	$.get({
		url: String('http://projektgil.cba.pl/KartaPostaciGilhar/serverScripts/getPage.php?page='+i),
		dataType: 'jsonp',
		//jsonpCallback: 'callback',
		//contentType: "application/json",
		crossDomain:'true',
		success: function(json) {
			console.log(json);
			
			strona=i;
			$("#extra_scripts").html("");
			
			var dom = $(json.data);
			
			$("#actual_page").html($.parseHTML(json.data));
			
			scriptsExecutionOrderGuard=new Array();

			dom.filter('script').each(function(index, value){
				scriptsExecutionOrderGuard[index]=false;
				if(this.src) {
					var script = document.createElement('script'), i, attrName, attrValue, attrs = this.attributes;
					for(i = 0; i < attrs.length; i++) {
						attrName = attrs[i].name;
						attrValue = attrs[i].value;
						script[attrName] = attrValue;
					}
					document.getElementById("extra_scripts").appendChild(script);
					//$.getScript('http://projektgil.cba.pl/KartaPostaciGilhar/'+attrValue);
					/*$.ajax({
						url: 'http://projektgil.cba.pl/KartaPostaciGilhar/'+attrValue,
						async: true,
						dataType: 'script',
						success: function(data, textStatus, jqxhr){
							eval(data);
							console.log('eval('+data+');');
							console.log(data);
							console.log(textStatus);
							console.log(jqxhr);
							scriptsExecutionOrderGuard[index]=true;
						},
						error: function(jqXHR, textStatus, errorThrown){
							console.log(jqXHR);
							console.log(textStatus);
							console.log(errorThrown);
						}
					});*/
					console.log("script src: "+attrValue);
					scriptsExecutionOrderGuard[index]=true;
				} else {
					while(index>0 && scriptsExecutionOrderGuard[index-1]!=true) setTimeout(function(){},100);
					var script = document.createElement('script');
					script.text=(this.text || this.textContent || this.innerHTML || '');
					document.getElementById("extra_scripts").appendChild(script);
					//$("#extra_scripts").append('<script>'+(this.text || this.textContent || this.innerHTML || ''));
					//$("#extra_scripts").append('<\/script>');
					//$.globalEval(this.text || this.textContent || this.innerHTML || '');
					console.log("script text");
					scriptsExecutionOrderGuard[index]=true;
				}
			});
			
			
			//eval($(json.data).find('script').html());
			localStorage.setItem("page"+i, json.data);
		},
		error: function() {
			$("#actual_page").html(localStorage.getItem("page"+i));
		}
	});
	var scale=$(window).width()/909;
	console.log(scale);
	$("#my_object").css({
		 "-webkit-transform": "scale("+scale+")",
		 "-moz-transform": "scale("+scale+")",
		 "-o-transform": "scale("+scale+")",
		 "-ms-transform": "scale("+scale+")"
	});
	$("#my_object").css("width", 1/scale*100+"%");
	$("#my_object").css("height", 1/scale*100+"%");
	w3_close();
}



$.ajax({
    type: "GET",
    url: 'http://projektgil.cba.pl/test.php',
	dataType: 'jsonp',//więc jak już mówiłem są wredne zabezpieczenia, które obchodzę nadmiarowym kodem
	jsonpCallback: 'callback',
    contentType: "application/json",
    crossDomain:'true',
	//headers: {'Origin': 'https://sigrond.github.io'},
    data: {
		name: "admin",
		pswd: MD5("admin")
		},
    success: function (json) {
        //process the json here.
		//alert(json.join(' '));
		console.log(json);
		var myStr=String("");
		$.each(json,function(i,v){
			myStr+=i+": "+v+", ";
		})
		$("#main").append(myStr);
    }
});

function logowanie(){
	var uname=String($("#Login").val());
	var upswd=String(MD5($("#Haslo").val()));//i tak cba nie daje darmowego ssl, a haslo nie musi zapewniać bezpieczeństwa
	$.ajax({
    type: "GET",
    url: 'http://projektgil.cba.pl/KartaPostaciGilhar/serverScripts/login.php',
	dataType: 'jsonp',//więc jak już mówiłem są wredne zabezpieczenia, które obchodzę nadmiarowym kodem
	jsonpCallback: 'callback',
    contentType: "text/html",
    crossDomain:'true',
    data: {
		name: uname,
		pswd: upswd
		},
    success: function (json) {
		console.log("login odpowiedzial");
		console.log(json.status);
		if(json.status==="OK")
		{
			sessionStorage.LoggedIn="true";
			sessionStorage.uname=uname;
			sessionStorage.upswd=upswd;
			$("#Login").attr("disabled", "disabled");
			$("#Haslo").attr("disabled", "disabled");
			$("#Logowanie").attr("disabled", "disabled");
			$("#Logowanie").val("Zalogowany!");
		}
    }
	});
}

$(document).ready(function(){
	if(sessionStorage.LoggedIn==="true")
	{
		$("#Login").val(sessionStorage.uname);
		$("#Haslo").val(sessionStorage.upswd);
		$("#Login").attr("disabled", "disabled");
		$("#Haslo").attr("disabled", "disabled");
		$("#Logowanie").attr("disabled", "disabled");
		$("#Logowanie").val("Zalogowany!");
	}
})

</script>



<!--<div id="actual_page" style="width:100%; height:100%; background-color:cyan; float:left;"></div>-->
<script>
	//$("#actual_page").html('<iframe id="my_object" type="text/html" src="1.html" style="width:100%;height:400%; -webkit-transform-origin: top left;"></iframe>');
	pokaz(1);
	/*console.log($("#my_object").contents());
	$("#my_object").ready(function(){
		$("#main").append($("#my_object").html());
	})*/
	var scale=$(window).width()/909;
	console.log(scale);
	$("#my_object").css({
		 "-webkit-transform": "scale("+scale+")",
		 "-moz-transform": "scale("+scale+")",
		 "-o-transform": "scale("+scale+")",
		 "-ms-transform": "scale("+scale+")"
	});
	$("#my_object").css("width", 1/scale*100+"%");
	$("#my_object").css("height", 1/scale*100+"%");
</script>
	
<div id="debug_div">
	<div id="debug_ids">CREATE TABLE DanePostaci ( id INT PRIMARY KEY UNIQUE, </div>
	<div id="debug_vals"></div>
</div>

</body>
</html>
